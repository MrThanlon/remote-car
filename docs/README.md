# 遥控小车

电子科技大学2019盟升杯H题（声音定位控制系统），小车程序及系统后端。

系统有以下几个部分

- **小车**，两主动轮的圆形小车，ESP8266主控，加一个超声波声源，Wi-Fi通信
- **定位**，使用四个超声波接收模块，根据超声波到达的时间差计算出小车位置
- **显示**，包括触摸控制部分，由树莓派+触摸屏实现，直接网页全屏完事

## 消息帧

### 帧结构

消息帧为不定长。

|     名称     |  长度（字节）  |                             说明                             |
| :----------: | :------------: | :----------------------------------------------------------: |
|     帧头     |       1        |                          固定为0x99                          |
| 消息类型标志 |       1        |                        表示消息的含义                        |
|    消息体    | 由消息类型决定 |                    一般说明这个消息的内容                    |
|     帧ID     |       2        | 随机数，主要用于重传，单位时间内唯一<br />对数据真假要求不高的消息一般不重传 |
|    校验和    |       1        |                   数据帧前部分的和，模0xFF                   |

### 一般消息

|      消息类型      | 标志位 |   方向   | 长度 |                        编码                        |                             说明                             |
| :----------------: | :----: | :------: | :--: | :------------------------------------------------: | :----------------------------------------------------------: |
|       心跳包       |  0x78  | 小车接收 |  0   |                         无                         |          默认10秒一次，收不到时小车会断线并发起重连          |
|      请求重传      |  0x9a  |   双向   |  2   |                       uint16                       |            校验失败，请求重新发送数据，数据为帧ID            |
|      车头角度      |  0x12  | 小车发送 |  2   |                   int16，1位小数                   |               开机时记角度为0，逆时针为正方向                |
| 目标绝对角度和车速 |  0x23  | 小车接收 |  4   |  角度为int16，1位小数；<br />车速为int16，2位小数  | 角度使用角度制，0-359.9，逆时针为正方向，车速单位为百分比。<br />以初始角度为绝对正方向。 |
|  目标角速度和车速  |  0x34  | 小车接收 |  4   | 角速度为int16，1位小数；<br />车速为int16，2位小数 | 角速度使用角度制，0-359.9，单位ang/s，逆时针为正方向，车速单位为百分比 |
|   左轮和右轮速度   |  0x56  | 小车接收 |  4   |                   int16，2位小数                   |                   用于直接控制，单位百分比                   |
|      当前位置      |  0xbc  | 定位发送 |  4   |              坐标x和y，int16，2位小数              |     以左下角为原点，单位：厘米，右为x正方向，上为y正方向     |

## 小车

小车主控作为TCP Client，控制车轮转速。

### 控制算法

以开机时候电子罗盘读取的方向为正方向，从上往下看逆时针为正，绝对角度控制使用**位置PID控制**，因为没有稳态误差所以KI和KD设置为0，用于调整两个轮子的转速差。

车速使用**速度PID控制**，因为没有稳态误差所以KI和KD设置为0。

轮子转速使用PWM波，总共4个控制引脚，IN1、IN2、IN3、IN4，IN1和IN2控制左轮，IN3和IN4控制右轮。IN1高IN2低正转，IN1低IN2高反转，IN3和IN4同理。PWM占空比范围是0~100%。

下面介绍**绝对角度控制**时候的速度环和角度环控制
$$
\frac{V_L+V_R}2=PID(V_{input},V_{current})
$$

$$
V_R-V_L=K*PID(\theta_{input},\theta_{current})
$$

$V_L$为左轮转速，$V_R$为右轮转速，$V_{input}$为输入车速，$V_{current}$为当前车速，$K$为一个系数，$\theta_{input}$为输入角度，$\theta_{current}$为当前角度。解这个方程即可得出$V_L$和$V_R$。得出结果之后将PWM占空比平滑过度到目标值。

## 定位

定位部分使用四个超声波接收器来完成。接收器在收到超声波时发出一个脉冲，通过树莓派读取四个位置超声波接收到的时间差来计算出当前小车的位置。

### 定位算法

接收器摆放在场地四个角，设场地边长1米，排放位置如下

```
B		|		A
---------
C		|		D
```

当A=0，即x,y>0的情况下

```
x = C^2/2 + D^2/2 - C*D + ((C - D)*(B - D + B*C^2 + B^2*C + 2*B^2*D - 3*C*D^2 + 5*C^2*D - (-(B - C + 1)*(C - B + 1)*(C - D + 1)*(D - C + 1)*(B^2 - 2*B*D + D^2 - 2))^(1/2) - B^3 - 2*C^3 + D^3 - 4*B*C*D))/(2*(B^2 - 2*B*C + 2*C^2 - 2*C*D + D^2 - 1))
y = C^2/2 - B^2/2 + B*D - C*D - (B*(B - D + B*C^2 + B^2*C + 2*B^2*D - 3*C*D^2 + 5*C^2*D - (-(B - C + 1)*(C - B + 1)*(C - D + 1)*(D - C + 1)*(B^2 - 2*B*D + D^2 - 2))^(1/2) - B^3 - 2*C^3 + D^3 - 4*B*C*D))/(2*(B^2 - 2*B*C + 2*C^2 - 2*C*D + D^2 - 1)) + (C*(B - D + B*C^2 + B^2*C + 2*B^2*D - 3*C*D^2 + 5*C^2*D - (-(B - C + 1)*(C - B + 1)*(C - D + 1)*(D - C + 1)*(B^2 - 2*B*D + D^2 - 2))^(1/2) - B^3 - 2*C^3 + D^3 - 4*B*C*D))/(2*(B^2 - 2*B*C + 2*C^2 - 2*C*D + D^2 - 1))
```

**注意这里为了方便计算，是以中心为原点，需要平移计算成数据帧。**

## 前端

前端完成控制数据的发送和数据展示。
